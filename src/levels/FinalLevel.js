import { Player } from "../entities/Player.js";
import { FinalEnemy } from "../entities/FinalEnemy.js";
import { TileMap } from "../components/TileMap.js";
import { Snake } from "../entities/Snake.js";
import { Priest } from "../entities/Priest.js";
import { Enemy } from "../entities/Enemy.js";
import { DialogTree } from "../interfaces/DialogTree.js";

export class FinalLevel extends Phaser.Scene
{
    constructor(PhaserGame)
    {
        super({key:"level-5"});

        this.count = 0;

        this.PhaserGame = PhaserGame;
    }

    create()
    {
        //Creating Level using an Array + Tile Map
        //1 is for block/tile; 0 is for empty space
        //25 wide by 19 long
        let level = 
        [   [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        ];

        this.loopImage('background2', 720, 420, level[0].length * 32, level.length * 32, 1.45);
        this.add.image(100,200, 'cloud');
        this.add.image(300,200, 'cloud');
        this.add.image(500,200, 'cloud');
        this.add.image(700,200, 'cloud');
        this.add.image(900,200, 'cloud');
        this.add.image(1100,200, 'cloud');
        this.add.image(1300,200, 'cloud');
        this.add.image(1500,200, 'cloud');
        this.add.image(1700,200, 'cloud');
        this.add.image(1900,200, 'cloud');
        this.add.image(2100,200, 'cloud');
        this.deadTree = this.add.image(450, 490, 'deadtree').setScale(1.75);
        this.cactus1 = this.add.image(800, 530, 'cactus');
        this.cactus2 = this.add.image(1100, 530, 'cactus');
        this.bigcrate = this.add.image(100, 532, 'crate').setScale(.9);


        this.map = new TileMap(this, level, 32, 32, 'sand');

        this.projectiles = {
            category: 2, //telling what collision category these objects belong in
            list: [] 
        };

        this.enemies = {
            category: 4,
            list: []
        };

        this.player = new Player(this, 100, 500);
        this.snake1 = new Snake(this, 500, 500);
        this.snake2 = new Snake(this, 700, 500);
        this.snake3 = new Snake(this, 900, 500);
        this.snake4 = new Snake(this, 1200, 500);
        this.snake5 = new Snake(this, 1500, 500);
        this.snake6 = new Snake(this, 1800, 500);

        // let dialogTree = new DialogTree(this, 600, 100);
        // let sequence1 = dialogTree.addSequence();
        // dialogTree.addDialog(sequence1, "This is the final level.");
        // dialogTree.addDialog(sequence1, "Get ready for the hardest fight of your life");
        // dialogTree.addDialog(sequence1, "Have fun");

        // dialogTree.playSequence(sequence1);
    }

    update ()
    {  
        //Update platforms
        for (let i = 0; i < this.map.platforms.list.length; ++i)
        {
            this.map.platforms.list[i]
        }

        //Update bullets
        for (let i = 0; i < this.projectiles.list.length; i++)
        {
            this.projectiles.list[i].update();
        }

        //Update enemies
        for (let i = 0; i < this.enemies.list.length; i++)
        {
            this.enemies.list[i].update();
        }
        
        if (this.enemies.list.length == 0) 
        {
            if(this.count == 0)
            {
                this.basicEnemy1 = new Enemy(this, 500, 500);
                this.basicEnemy2 = new Enemy(this, 700, 500);
                this.basicEnemy3 = new Enemy(this, 900, 500);
                this.basicEnemy4 = new Enemy(this, 1200, 500);
                this.basicEnemy5 = new Enemy(this, 1500, 500);
                this.basicEnemy6 = new Enemy(this, 1800, 500);
                this.count = this.count + 1;
            }
            else if(this.count == 1)
            {
                this.preist1 = new Priest(this, 500, 500);
                this.priest2 = new Priest(this, 700, 500);
                this.priest3 = new Priest(this, 900, 500);
                this.priest4 = new Priest(this, 1200, 500);
                this.priest5 = new Priest(this, 1500, 500);
                this.priest6 = new Priest(this, 1800, 500);
                this.count = this.count + 1;
            }

            else if(this.count == 2)
            {
                this.finalBoss = new FinalEnemy(this, 500, 500).setScale(5);
                this.count = this.count + 1;
            }

            else if(this.count == 3)
            {
                console.log("You Win!!!");
            }
            
        }

        this.player.update();
    }

    loopImage(imageKey, imageWidth, imageHeight, levelWidth, levelHeight, scale) 
    {
        let maxWidth = Math.max(this.cameras.main.worldView.width, levelWidth);
        let maxHeight = Math.max(this.cameras.main.worldView.height, levelHeight);

        let widthRatio = maxWidth / (imageWidth * scale); //Getting the ratio between level size and background image size
        let heightRatio = maxHeight / (imageHeight * scale);

        let numberOfWidth = Math.ceil(widthRatio);
        let numberOfHeight = Math.ceil(heightRatio);

        for (let w = 0; w < numberOfWidth; ++w)
        {
            for (let h = 0; h < numberOfHeight; ++h)
            {
                let bgImage = new Phaser.GameObjects.Image(this, 0, 0, imageKey);
                bgImage.setOrigin(0, 0).setScale(scale).setPosition(imageWidth * w * scale, imageHeight * h * scale);
                this.add.existing(bgImage);
            }
        }
    }
}